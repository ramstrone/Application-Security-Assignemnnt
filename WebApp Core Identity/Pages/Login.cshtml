@page
@model WebApp_Core_Identity.Pages.LoginModel
@{
 ViewData["Title"] = "Login";
}

<h2>Login</h2>

<form method="post" id="loginForm">
 @Html.AntiForgeryToken()
 <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

 @if (ViewData["MustChangePassword"] != null)
 {
 <div class="alert alert-warning">Your password has expired — please sign in and change your password.</div>
 }

 <input type="hidden" name="MustChangePassword" value="@(Model.MustChangePassword ?? "")" />

 <div class="mb-3">
 <label asp-for="LModel.Email" class="form-label"></label>
 <input asp-for="LModel.Email" class="form-control" autocomplete="email" />
 <span asp-validation-for="LModel.Email" class="text-danger"></span>
 </div>
 <div class="mb-3">
 <label asp-for="LModel.Password" class="form-label"></label>
 <input asp-for="LModel.Password" class="form-control" type="password" autocomplete="current-password" />
 <span asp-validation-for="LModel.Password" class="text-danger"></span>
 </div>
 <input type="hidden" id="g-recaptcha-response" name="gRecaptchaToken" />

 <button type="submit" class="btn btn-primary">Login</button>

 <div class="mt-3">
 <a asp-page="/Account/ForgotPassword">Forgot your password?</a>
 </div>
</form>

@section Scripts {
 @if (!string.IsNullOrEmpty(Model.RecaptchaSiteKey))
 {
 <script src="https://www.google.com/recaptcha/api.js?render=@Model.RecaptchaSiteKey"></script>
 <script>
 (function () {
 const siteKey = '@Model.RecaptchaSiteKey';
 const form = document.getElementById('loginForm');
 const tokenInput = document.getElementById('g-recaptcha-response');
 const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
 let inFlight = false;

 async function requestTokenAndSubmit() {
 // guard: don't request twice
 if (inFlight) return;
 inFlight = true;
 if (submitBtn) submitBtn.disabled = true;

 // Fallback submit if grecaptcha never becomes ready
 const fallback = setTimeout(() => {
 if (inFlight) {
 inFlight = false;
 if (submitBtn) submitBtn.disabled = false;
 form.submit();
 }
 }, 5000);

 try {
 if (typeof grecaptcha === 'undefined') {
 // library not present (blocked) -> submit and let server handle
 clearTimeout(fallback);
 inFlight = false;
 if (submitBtn) submitBtn.disabled = false;
 form.submit();
 return;
 }

 // wait until grecaptcha is initialized
 grecaptcha.ready(async function () {
 try {
 const token = await grecaptcha.execute(siteKey, { action: 'login' });
 if (tokenInput) tokenInput.value = token || '';
 } catch (e) {
 console.warn('grecaptcha.execute failed', e);
 } finally {
 clearTimeout(fallback);
 inFlight = false;
 if (submitBtn) submitBtn.disabled = false;
 form.submit();
 }
 });
 } catch (e) {
 console.error('reCAPTCHA flow error', e);
 clearTimeout(fallback);
 inFlight = false;
 if (submitBtn) submitBtn.disabled = false;
 form.submit();
 }
 }

 if (form) {
 form.addEventListener('submit', function (evt) {
 evt.preventDefault();
 requestTokenAndSubmit();
 });
 }
 })();
 </script>
 }
}

